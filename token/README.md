Token Generator / Verifier
==========================
This module allows to generate sha256 signed tokens as described by https://github.com/facebook/DelegatedRecoverySpecification/blob/master/draft-hill-delegated-recovery.raw.txt#L1396

*TODO If an alternative is found replace this module by a more widespread one and with better support from community.*

## Usage
```js
// Building a token
const tokenHelper = require('./');
const schema =   [
  {
    property: 'version',
    type: 'uint8'
  },

  {
    property: 'issuer_length',
    type: 'uint16'
  },

  {
    property: 'issuer',
    type: 'string',
    length: { property: 'issuer_length' }
  }
];

const privateKey = [
    '-----BEGIN EC PRIVATE KEY-----',
    'MHcCAQEEIK9dHkWULFKUmFxukjez6z0mnmiSO3XHPFnFCWOrRFBGoAoGCCqGSM49',
    'AwEHoUQDQgAEU2eUvr2awpksy9Ipsz2tdDx7gdm+emNsgglLWSvZR2IDKEnsuME+',
    'oGPkWdG0qDPhjlStVDaafZiVdie40WWV6A==',
    '-----END EC PRIVATE KEY-----'
  ].join('\n');

const token = tokenHelper.sign({ schema }, {
  version: 2,
  issuer: 'http://me.com'
}, privateKey);

console.log(token);

// Verifying the token
const publicKey1 = [
    '-----BEGIN PUBLIC KEY-----',
    'MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEU2eUvr2awpksy9Ipsz2tdDx7gdm+',
    'emNsgglLWSvZR2IDKEnsuME+oGPkWdG0qDPhjlStVDaafZiVdie40WWV6A==',
    '-----END PUBLIC KEY-----'
  ].join('\n');

// const publicKey2 = '-----BEGIN PUBLIC KEY-----',
// ...
// '-----END PUBLIC KEY-----'

try {
  const decodedToken = tokenHelper.verifySignature({ schema }, [
    publicKey1,
    // publicKey2,
    // ...
  ], token);
  console.log(decodedToken); // { version: 2, issuer: 'http://me.com' }
} catch (e) {
  console.log('Invalid token', e);
}
```

## API
### .sign({ schema }, values, privateKeyPem)
Builds a token based on the schema and the values and signs it using
the provided private key + `sha256` as hashing a mechanism.

**Returns (string):** base64 encoded token string.

**Parameters**
* schema (array.<object>): token schema as described here.
Example:
```js
  [
    {
      property: 'version',
      type: 'uint8'
    },

    {
      property: 'issuer_length',
      type: 'uint16'
    },

    {
      property: 'issuer',
      type: 'string',
      length: { property: 'issuer_length' }
    }
  ]
```

* values (object): map-object with the property names described in the schema as keys and the values for these properties as values.
Example:
```js
{
  version: 2,
  issuer: 'http://me.com'
}
```

* privateKeyPem (string): Private key PEM to sign the token.
Example
```
    -----BEGIN EC PRIVATE KEY-----
    MHcCAQEEIK9dHkWULFKUmFxukjez6z0mnmiSO3XHPFnFCWOrRFBGoAoGCCqGSM49
    AwEHoUQDQgAEU2eUvr2awpksy9Ipsz2tdDx7gdm+emNsgglLWSvZR2IDKEnsuME+
    oGPkWdG0qDPhjlStVDaafZiVdie40WWV6A==
    -----END EC PRIVATE KEY-----
```
*WARNING*: DO NOT USE THIS PRIVATE KEY, it is exposed in a public repo
so it is not private anymore; below you will find methods to generate your
own key.

### .verifySignature({ schema }, publicKeyPems, token)
Given a token and an schema for its structure, decodes the token and verifies the signature.

**Returns (object)** Decoded token if the signature is valid

**Throws**
* InvalidTokenError: if `token` is not a buffer or an string or its payload cannot be decoded based on the provided schema.

* InvalidSignatureError: if `token` signature is invalid.

**Parameters**
* schema (array.<object>): expected token schema as described here. It will be used to decode the token, if the token cannot be decoded based
on the schema a `InvalidTokenError` will be thrown.

Example:
```js
  [
    {
      property: 'version',
      type: 'uint8'
    },

    {
      property: 'type',
      type: 'uint8'
    },

    {
      property: 'token_id',
      type: 'bytes',
      length: { value: 16 }
    },

    {
      property: 'issuer_length',
      type: 'uint16'
    },

    {
      property: 'issuer',
      type: 'string',
      length: { property: 'issuer_length' }
    }
  ]
```

* publicKeyPems (string|Array.<string>): Public key PEM/s to validate token signature.
Example
```
    -----BEGIN PUBLIC KEY-----
    MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEU2eUvr2awpksy9Ipsz2tdDx7gdm+
    emNsgglLWSvZR2IDKEnsuME+oGPkWdG0qDPhjlStVDaafZiVdie40WWV6A==
    -----END PUBLIC KEY-----
```

* token (string|Buffer): base64 encoded token as generated by `#sign` method or buffer for the token to be validated against the public key.

## Generating key pairs

* Private key for curve "prime256v1"
```
  openssl ecparam -name prime256v1 -genkey -noout -out private_key.pem
```

* Public keys for Private key
```
  openssl ec -in private_key.pem -pubout -out publick_key.pem
```

#### Source
https://wiki.openssl.org/index.php/Command_Line_Elliptic_Curve_Operations
